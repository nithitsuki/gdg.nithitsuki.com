name: Meme Factory CI/CD

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'meme_generator/meme_input.json'

permissions:
  # We now need write permissions for contents to push a commit
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        # Provide a token to allow committing back to the repo
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Python dependencies
        run: pip install -r meme_generator/requirements.txt

      - name: Generate Meme via Imgflip API
        id: generate_meme
        env:
          IMGFLIP_USERNAME: ${{ secrets.IMGFLIP_USERNAME }}
          IMGFLIP_PASSWORD: ${{ secrets.IMGFLIP_PASSWORD }}
        run: |
          echo "MEME_OUTPUT=$(python meme_generator/generate_meme.py)" >> $GITHUB_OUTPUT

      - name: Update Meme History
        run: |
          if [ ! -f meme_history.json ]; then
            echo "[]" > meme_history.json
          fi
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          COMMIT_AUTHOR="${{ github.actor }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          MEME_URLS='${{ steps.generate_meme.outputs.MEME_OUTPUT }}'
          INPUT_DATA=$(cat meme_generator/meme_input.json)
          jq \
            --argjson urls "$MEME_URLS" \
            --argjson input "$INPUT_DATA" \
            --arg sha "$COMMIT_SHA" \
            --arg msg "$COMMIT_MSG" \
            --arg author "$COMMIT_AUTHOR" \
            --arg ts "$TIMESTAMP" \
            '[
              {
                "commitId": $sha,
                "commitMessage": $msg,
                "author": $author,
                "timestamp": $ts,
                "templateId": $input.templateId,
                "caption": { "text0": $input.text0, "text1": $input.text1 },
                "imageUrl": $urls.imageUrl,
                "pageUrl": $urls.pageUrl
              }
            ] + .' meme_history.json > temp_history.json && mv temp_history.json meme_history.json
          echo "meme_history.json updated successfully."

      # --- NEW ROBUSTNESS STEP ---
      # Commit the updated history file back to the main branch.
      - name: Commit updated meme_history.json
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add meme_history.json
          # Check if there are changes to commit to avoid errors
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "docs: Update meme history [skip ci]"
            git push
          fi

      - name: Prepare Deployment Artifacts
        run: |
          mkdir deploy
          cp meme_generator/index.html deploy/
          cp meme_generator/script.js deploy/
          cp meme_history.json deploy/

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./deploy