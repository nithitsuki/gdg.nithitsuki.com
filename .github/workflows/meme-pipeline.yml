name: Meme Factory CI/CD

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'meme_generator/meme_input.json'

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # --- MODIFIED STEP ---
      # The Python setup is no longer needed. We now build and run a Docker container.
      - name: Build and Run Meme Generator in Docker
        id: generate_meme
        run: |
          # Build the Docker image from our Dockerfile
          docker build -t meme-factory .

          # Run the container, passing the secrets as environment variables
          # The output of the script (the JSON) is captured here
          echo "MEME_OUTPUT=$(docker run \
            -e IMGFLIP_USERNAME=${{ secrets.IMGFLIP_USERNAME }} \
            -e IMGFLIP_PASSWORD=${{ secrets.IMGFLIP_PASSWORD }} \
            meme-factory)" >> $GITHUB_OUTPUT

      - name: Update Meme History
        run: |
          if [ ! -f meme_history.json ]; then
            echo "[]" > meme_history.json
          fi
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          COMMIT_AUTHOR="${{ github.actor }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          MEME_URLS='${{ steps.generate_meme.outputs.MEME_OUTPUT }}'
          INPUT_DATA=$(cat meme_generator/meme_input.json)
          jq \
            --argjson urls "$MEME_URLS" \
            --argjson input "$INPUT_DATA" \
            --arg sha "$COMMIT_SHA" \
            --arg msg "$COMMIT_MSG" \
            --arg author "$COMMIT_AUTHOR" \
            --arg ts "$TIMESTAMP" \
            '[
              {
                "commitId": $sha,
                "commitMessage": $msg,
                "author": $author,
                "timestamp": $ts,
                "templateId": $input.templateId,
                "caption": { "text0": $input.text0, "text1": $input.text1 },
                "imageUrl": $urls.imageUrl,
                "pageUrl": $urls.pageUrl
              }
            ] + .' meme_history.json > temp_history.json && mv temp_history.json meme_history.json
          echo "meme_history.json updated successfully."

      - name: Commit updated meme_history.json
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add meme_history.json
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "docs: Update meme history [skip ci]"
            git push
          fi

      - name: Prepare Deployment Artifacts
        run: |
          mkdir deploy
          cp meme_generator/index.html deploy/
          cp meme_generator/script.js deploy/
          cp meme_history.json deploy/

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./deploy